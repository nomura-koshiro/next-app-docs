# テスト戦略

プロジェクト全体のテスト戦略とアプローチについて説明します。テストピラミッド、各テストレベルの役割、カバレッジ目標を解説します。

## 目次

1. [テスト戦略の概要](#テスト戦略の概要)
2. [テストピラミッド](#テストピラミッド)
3. [テストの種類と目的](#テストの種類と目的)
4. [何をテストするか](#何をテストするか)
5. [テスト実装状況](#テスト実装状況)
6. [カバレッジ目標](#カバレッジ目標)
7. [コマンド一覧](#コマンド一覧)

---

## テスト戦略の概要

本プロジェクトでは、**テストピラミッド**に基づいた多層的なテスト戦略を採用しています。

### 基本方針

- **ユニットテストを厚く**: 小さく、速く、多く
- **統合テストを適度に**: 重要な機能を中心に
- **E2Eテストを薄く**: クリティカルパスのみ

---

## テストピラミッド

```text
       /\
      /  \     E2Eテスト (少)
     /____\    - Playwright
    /      \   - ユーザーフロー
   /        \
  /__________\ 統合テスト (中)
 /            \ - Storybook Interaction
/              \ - React Testing Library
/______________\ ユニットテスト (多)
                 - Vitest
                 - 関数・フック単体
```

### レイヤーごとの特徴

| レイヤー | 実行速度 | コスト | 信頼性 | テスト数 |
|---------|---------|--------|--------|---------|
| **ユニット** | 高速 | 低 | 低 | 多 |
| **統合** | 中速 | 中 | 中 | 中 |
| **E2E** | 低速 | 高 | 高 | 少 |

---

## テストの種類と目的

### 1. ユニットテスト (Vitest)

**目的**: 関数・フック・ユーティリティの単体テスト

| 対象 | ツール | 例 |
|------|--------|---|
| ユーティリティ関数 | Vitest | `formatDate()`, `cn()` |
| カスタムフック | Vitest + @testing-library/react | `useDebounce()` |
| ビジネスロジック | Vitest | バリデーション関数 |

### 2. コンポーネントテスト (React Testing Library)

**目的**: UIコンポーネントの振る舞いテスト

| 対象 | ツール | 例 |
|------|--------|---|
| 共通UIコンポーネント | Vitest + RTL | Button, Input, Card |
| フォームコンポーネント | Vitest + RTL + userEvent | LoginForm |
| データ表示コンポーネント | Vitest + RTL + MSW | UserList |

### 3. インタラクションテスト (Storybook)

**目的**: コンポーネントの状態遷移とユーザー操作

| 対象 | ツール | 例 |
|------|--------|---|
| インタラクティブUI | Storybook + play関数 | Modal, Dropdown |
| フォームバリデーション | Storybook + userEvent | 入力検証 |
| API連携 | Storybook + MSW | データ取得表示 |

### 4. E2Eテスト (Playwright)

**目的**: エンドツーエンドのユーザーフロー

| 対象 | ツール | 例 |
|------|--------|---|
| 認証フロー | Playwright | ログイン→ダッシュボード |
| CRUD操作 | Playwright | 作成→編集→削除 |
| クリティカルパス | Playwright | 購入フロー |

---

## 何をテストするか

### ✅ テストすべきもの

1. **ビジネスロジック**
   - データ変換・計算
   - バリデーションルール
   - 条件分岐

2. **ユーザーインタラクション**
   - ボタンクリック時の動作
   - フォーム送信
   - エラー表示

3. **重要な統合ポイント**
   - API連携
   - 状態管理
   - ルーティング

### ❌ テスト不要なもの

1. **サードパーティライブラリ**
   - React本体の動作
   - Next.jsのルーター（基本動作）
   - Tailwind CSSのスタイル

2. **実装詳細**
   - useState内部の動作
   - コンポーネントのprops名
   - CSS class名

3. **定数・型定義**
   - TypeScriptの型チェックに任せる

---

## テスト実装状況

> **📝 現在の実装状況 (2025年1月時点)**

| テストタイプ | ツール | 状態 |
|------------|--------|------|
| **Storybookインタラクション** | Storybook + Vitest | ✅ 設定済み |
| **ユニットテスト** | Vitest | 🚧 設定済み・実装進行中 |
| **コンポーネントテスト** | Vitest + RTL | 🚧 設定済み・実装進行中 |
| **E2Eテスト** | Playwright | ⚠️ インストール済み・未設定 |

---

## カバレッジ目標

### 目標値

| カテゴリ | 目標カバレッジ |
|---------|--------------|
| **ユーティリティ関数** | 90%以上 |
| **カスタムフック** | 80%以上 |
| **共通UIコンポーネント** | 70%以上 |
| **Featureコンポーネント** | 60%以上 |
| **全体** | 70%以上 |

### カバレッジ確認

```bash
# カバレッジレポート生成
pnpm test:coverage

# カバレッジをブラウザで確認
open coverage/index.html
```

---

## コマンド一覧

### ユニット・コンポーネントテスト

```bash
# すべてのテスト実行
pnpm test

# ウォッチモード
pnpm test:watch

# カバレッジ
pnpm test:coverage

# UIモード
pnpm test:ui
```

### Storybookインタラクションテスト

```bash
# Storybook起動
pnpm storybook

# test-runner実行
pnpm test-storybook
```

### E2Eテスト

```bash
# E2Eテスト実行
pnpm e2e

# ヘッドモード
pnpm e2e:headed

# UIモード
pnpm e2e:ui
```

---

## 参考リンク

- [ユニットテスト](./02-unit-testing.md)
- [コンポーネントテスト](./03-component-testing.md)
- [Storybookインタラクション](./04-storybook-interaction.md)
- [E2Eテスト](./05-e2e-testing.md)
- [ベストプラクティス](./06-best-practices.md)
